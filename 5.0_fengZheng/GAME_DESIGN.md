# 风筝渡河 - 游戏设计文档

## 一、核心玩法

### 1.1 游戏流程
```
主菜单 → 选择河流地图 → 装备准备 → 实时控制 → 结算评分
```

### 1.2 核心循环
1. **资源管理**：初始资金1000￥，购买组件组装风筝
2. **策略规划**：根据河流环境（风速、水流、湿度、天气）选择组件
3. **NPC咨询**：3次咨询机会，付费提升建议准确度，白嫖降低NPC心情
4. **实时控制**：AWSD控制风筝移动，模拟渡河过程
5. **评分结算**：三颗星系统（成功渡河、咨询过专家、预算合理）

## 二、核心逻辑

### 2.1 组件系统
```python
组件属性：
- 面积(area): 影响升力
- 稳定性(stability): 抗风能力
- 控制(control): 操作灵活性
- 高度(height): 起飞高度（高架）
- 重量(weight): 负值表示减重
```

### 2.2 成功判定公式
```python
score = lift * wind * 0.6          # 升力 × 风速
      + stability * 1.2             # 稳定性加权
      + control                      # 控制力
      + height * 2                   # 高度优势
      - flow * 5                     # 水流阻力
      - humidity * 8                 # 湿度惩罚

success = score >= 140
```

### 2.3 NPC心情系统
- **心情值范围**：10-100
- **准确度影响**：
  - 心情≥70：100%准确
  - 心情40-69：75%准确
  - 心情<40：50%准确
- **交互影响**：
  - 付费咨询：+12心情，-20￥
  - 白嫖咨询：-10心情

### 2.4 评分系统（三颗星）
1. ⭐ 成功渡河（score >= 140）
2. ⭐ 咨询过专家（chats > 0）
3. ⭐ 预算合理（花费 ≤ 500￥）

## 三、数据结构

### 3.1 游戏状态 (GameState)
```python
- money: 资金
- map_key: 当前选择的地图
- assembled: 已组装的组件列表
- inventory: 背包中的组件
- npc_mood: NPC心情字典
- chats: 咨询次数（上限3）
- memory: NPC记忆字典
```

### 3.2 地图数据 (MAPS)
```python
{
    "河流名": {
        "weather": 天气,
        "humidity": 湿度(0-1),
        "wind": 风速(m/s),
        "flow": 水流速度,
        "bounty": (最低, 最高)赏金,
        "pos": (x, y) 世界地图坐标
    }
}
```

## 四、前端实现改进建议

### 4.1 当前问题
1. **交互体验**：按钮控制不够流畅，缺少键盘事件
2. **视觉效果**：像素图生成简单，缺少动画过渡
3. **游戏性**：控制过程过于简化，缺少物理模拟
4. **反馈机制**：缺少实时参数显示和预警

### 4.2 改进方案

#### A. 技术栈升级
```javascript
// 方案1: Canvas + JavaScript
- 使用HTML5 Canvas实现实时渲染
- 键盘事件监听（AWSD）
- requestAnimationFrame实现流畅动画

// 方案2: Pygame (本地运行)
- 真正的游戏引擎
- 物理引擎（pymunk）
- 音效和背景音乐

// 方案3: React + Three.js (Web)
- 3D像素风格渲染
- 更丰富的视觉效果
- 响应式设计
```

#### B. 核心功能增强

**1. 实时物理模拟**
```python
# 风筝物理属性
- 重力加速度
- 风力影响（根据环境风速）
- 阻力计算
- 拉线张力
```

**2. 键盘控制优化**
```javascript
// 替代按钮控制
document.addEventListener('keydown', (e) => {
    if (e.key === 'a' || e.key === 'A') moveLeft();
    if (e.key === 'w' || e.key === 'W') moveUp();
    // ...
});
```

**3. 实时数据可视化**
```python
# 显示实时参数
- 当前升力值
- 稳定性指标
- 距离对岸进度
- 剩余时间/能量
```

**4. 动画系统**
```python
# 动画效果
- 风筝飞行轨迹
- 拉线摆动
- 水波动画
- 落水水花（逐帧动画）
- 成功庆祝动画
```

**5. 音效系统**
```python
# 音效设计
- 背景音乐（像素风格BGM）
- 购买音效
- 控制音效
- 成功/失败音效
```

#### C. UI/UX优化

**1. 组件商店**
- 拖拽式组装界面
- 组件预览（3D旋转）
- 属性对比图表
- 推荐组合提示

**2. 游戏画面**
- 更大画布（800x400）
- 多图层渲染（背景/河流/人物/风筝）
- 粒子效果（风、水花）
- 天气效果（雨、云）

**3. 信息面板**
- 实时性能仪表盘
- 环境参数可视化
- NPC对话气泡
- 进度条（渡河进度）

## 五、推荐实现路径

### 阶段1：基础优化（当前Streamlit）
- ✅ 添加键盘事件监听（streamlit-keyup）
- ✅ 优化像素图生成算法
- ✅ 添加过渡动画
- ✅ 改进UI布局

### 阶段2：Canvas升级
- 使用`st_canvas`组件
- 实现实时渲染循环
- 添加物理模拟
- 键盘控制集成

### 阶段3：独立游戏（可选）
- Pygame版本
- 完整游戏循环
- 存档系统
- 成就系统

## 六、关键代码位置

### 6.1 核心逻辑
- `game.py: simulate_cross()` - 成功判定
- `game.py: _kite_stats()` - 性能计算
- `game.py: npc_advice()` - NPC建议系统

### 6.2 渲染系统
- `game.py: build_world_map()` - 世界地图
- `game.py: build_river_scene()` - 河流场景
- `game.py: draw_person_with_kite()` - 人物和风筝

### 6.3 前端控制
- `streamlit_app.py: game_screen()` - 游戏主界面
- `streamlit_app.py: controls()` - 控制逻辑

## 七、扩展建议

1. **多难度模式**：简单/普通/困难
2. **排行榜系统**：最佳分数/最快通关
3. **自定义地图**：玩家创建河流挑战
4. **组件升级**：组件可升级强化
5. **剧情模式**：加入故事线和解谜元素

